name: Sync from Upstream Template

on:
  # 定时触发：每周一上午8点自动运行（北京时间）
  schedule:
    - cron: '0 0 * * 1'
  
  # 手动触发：在 GitHub Actions 页面可以手动运行
  workflow_dispatch:
    inputs:
      reason:
        description: '手动同步原因'
        required: false
        default: '手动触发同步'

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 授予向仓库写入的权限

    steps:
      # 1. 检出您的项目代码
      - name: Checkout your repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # 获取完整历史，便于合并

      # 2. 配置 Git 用户（用于后续提交）
      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # 3. 添加上游仓库地址（请确保地址正确）
      - name: Add upstream remote
        run: |
          # 请将下面的URL替换为您的原始模板仓库地址
          git remote add upstream https://github.com/sansan0/TrendRadar.git || true
          git fetch upstream

      # 4. 核心：合并上游更新，并按照您的规则处理冲突
      - name: Merge upstream with backup strategy
        id: merge
        run: |
          # 获取当前分支名（main 或 master）
          CURRENT_BRANCH=$(git branch --show-current)
          echo "当前分支: $CURRENT_BRANCH"

          # 尝试合并，但遇到冲突时暂停，不自动提交
          echo "正在尝试合并上游更新..."
          if git merge upstream/$CURRENT_BRANCH --no-commit; then
            echo "状态：无冲突，可以自动合并。"
            echo "merged=clean" >> $GITHUB_OUTPUT
          else
            echo "状态：检测到冲突，开始执行备份和覆盖策略。"

            # 找出所有处于冲突状态的文件
            CONFLICTED_FILES=$(git diff --name-only --diff-filter=U)
            echo "冲突文件列表："
            echo "$CONFLICTED_FILES"

            for file in $CONFLICTED_FILES; do
              echo "处理文件: $file"
              # 1. 备份本地版本
              if [ -f "$file" ]; then
                backup_file="${file}.backup"
                echo "  备份本地版本 -> $backup_file"
                cp "$file" "$backup_file"
              fi
              # 2. 强制采用上游版本（检出“他们的”版本）
              echo "  采用上游版本覆盖本地文件"
              git checkout --theirs -- "$file"
              # 3. 将解决方案标记为已解决
              git add "$file"
            done

            echo "所有冲突已按规则（上游优先+本地备份）解决。"
            echo "merged=with_backup" >> $GITHUB_OUTPUT
          fi

      # 5. 提交合并结果
      - name: Commit the merge
        if: steps.merge.outputs.merged != ''
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          commit_msg="chore: sync updates from upstream"
          
          if [ "${{ steps.merge.outputs.merged }}" = "with_backup" ]; then
            commit_msg="$commit_msg (conflicts resolved using upstream version, local files backed up)"
          else
            commit_msg="$commit_msg"
          fi
          
          git commit -m "$commit_msg"
          echo "已创建提交。"

      # 6. 推送更新到您的仓库
      - name: Push changes
        if: steps.merge.outputs.merged != ''
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          git push origin $CURRENT_BRANCH
          echo "更新已成功推送到 origin/$CURRENT_BRANCH"
