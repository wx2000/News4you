name: Sync from Upstream Template

on:
  # 定时触发：每周一上午8点自动运行（北京时间）
  schedule:
    - cron: '0 0 * * 1'
  
  # 手动触发：在 GitHub Actions 页面可以手动运行
  workflow_dispatch:
    inputs:
      reason:
        description: '手动同步原因'
        required: false
        default: '手动触发同步'

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout your repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote and fetch
        run: |
          # 1. 添加正确的上游仓库URL
          git remote add upstream https://github.com/sansan0/TrendRadar.git
          # 2. 获取上游所有分支和标签
          git fetch upstream

      - name: Determine default branch and merge
        id: sync
        run: |
          # 获取本地默认分支名 (可能是 main 或 master)
          LOCAL_DEFAULT_BRANCH=$(git branch --show-current)
          echo "本地默认分支: $LOCAL_DEFAULT_BRANCH"

          # 获取上游仓库的默认分支名（通常为 main 或 master）
          # 这里我们假设上游也是 main，如果上游是 master，请将下一行改为 UPSTREAM_DEFAULT_BRANCH="master"
          UPSTREAM_DEFAULT_BRANCH="master"
          echo "上游默认分支: $UPSTREAM_DEFAULT_BRANCH"

          # 尝试合并上游的默认分支到本地的默认分支
          echo "正在执行: git merge upstream/$UPSTREAM_DEFAULT_BRANCH --no-commit"
          if git merge upstream/$UPSTREAM_DEFAULT_BRANCH --no-commit; then
            echo "状态：自动合并成功，无冲突。"
            echo "merged=clean" >> $GITHUB_OUTPUT
          else
            echo "状态：检测到冲突，执行备份覆盖策略。"
            CONFLICTED_FILES=$(git diff --name-only --diff-filter=U)
            echo "冲突文件: $CONFLICTED_FILES"
            for file in $CONFLICTED_FILES; do
              echo "处理: $file"
              if [ -f "$file" ]; then
                cp "$file" "${file}.backup"
                echo "  已备份为: ${file}.backup"
              fi
              git checkout --theirs -- "$file"
              git add "$file"
            done
            echo "状态：所有冲突已解决（采用上游版本）。"
            echo "merged=with_backup" >> $GITHUB_OUTPUT
          fi

      - name: Commit the merge
        if: steps.sync.outputs.merged != ''
        run: |
          # 仅在确实有内容可提交时才执行
          if ! git diff --cached --quiet; then
            CURRENT_BRANCH=$(git branch --show-current)
            COMMIT_MSG="chore: sync updates from upstream"
            if [ "${{ steps.sync.outputs.merged }}" = "with_backup" ]; then
              COMMIT_MSG="$COMMIT_MSG (conflicts resolved, backup created)"
            fi
            git commit -m "$COMMIT_MSG"
            echo "合并提交已完成。"
          else
            echo "无变更需要提交，跳过提交步骤。"
          fi

      - name: Push changes
        if: steps.sync.outputs.merged != ''
        run: |
          # 只有在提交后，本地分支领先于远程时，才需要推送
          if git status | grep -q 'ahead of'; then
            CURRENT_BRANCH=$(git branch --show-current)
            git push origin $CURRENT_BRANCH
            echo "更新已推送至 origin/$CURRENT_BRANCH"
          else
            echo "本地分支与远程分支同步，无需推送。"
          fi
