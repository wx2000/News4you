name: Sync from Upstream Template

on:
  # 定时触发：每周一上午8点自动运行（北京时间）
  schedule:
    - cron: '0 0 * * 1'
  
  # 手动触发：在 GitHub Actions 页面可以手动运行
  workflow_dispatch:
    inputs:
      reason:
        description: '手动同步原因'
        required: false
        default: '手动触发同步'

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出你的仓库代码
      - name: Checkout your repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 获取完整历史记录
      
      # 2. 设置 Git 用户信息（用于提交记录）
      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      # 3. 添加上游仓库地址
      - name: Add upstream remote
        run: |
          # 替换下面的 URL 为你的模板仓库地址
          git remote add upstream https://github.com/sansan0/TrendRadar.git
          git fetch upstream
      
      # 4. 尝试合并上游更新
      - name: Merge upstream changes
        run: |
          # 尝试合并，如果冲突则跳过
          git merge upstream/main --allow-unrelated-histories -m "chore: sync updates from upstream [skip ci]" || echo "合并失败，可能存在冲突"
        continue-on-error: true
      
      # 5. 推送更新到你的仓库
      - name: Push changes
        run: |
          # 首先，获取远程仓库的最新信息，确保知晓远程分支状态
          git fetch origin
          
          # 检查本地当前分支（应为 main 或 master），并明确设置上游分支
          CURRENT_BRANCH=$(git branch --show-current)
          echo "当前分支是: $CURRENT_BRANCH"
          
          # 将本地分支与远程同名分支关联（如果尚未关联）
          git branch --set-upstream-to=origin/$CURRENT_BRANCH $CURRENT_BRANCH 2>/dev/null || echo "分支关联已存在或暂不关联"
          
          # 检查本地分支与远程分支是否有差异
          if git diff --quiet HEAD origin/$CURRENT_BRANCH; then
            echo "本地分支 '$CURRENT_BRANCH' 与远程分支 'origin/$CURRENT_BRANCH' 内容一致，没有新内容需要推送。"
          else
            echo "检测到差异，正在推送更新..."
            git push origin $CURRENT_BRANCH
            echo "更新已成功推送到 origin/$CURRENT_BRANCH"
          fi
